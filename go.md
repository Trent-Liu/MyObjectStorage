### 分布式系统

接口与数据分离，向集群中随意添加新的接口服务节点或者数据服务节点。

GET获取资源

PUT 创建或者替换

POST 如果资源存在，返回错误而不是替换覆盖

DELETE 删除





接口层：apiServer包

提供对外的REST接口，处理客户端的请求，向数据服务存取对象

将客户端PUT上来的数据流切成4+2的分片，然后向6个数据服务节点上传临时对象\<hash\>.X

object包：PUT GET等方法，负责将对象请求转发给数据服务

* PUT方法

  散列值+长度，添加新版本

* GET方法

  指定版本，名字+版本号获取元数据。

* DELETE方法

  删除对象时在元数据中给对象添加一个表示删除的特殊版本

heartbeat包：接收数据服务节点的心跳消息

locate包：发送定位消息并处理反馈信息，超时时间内收到所有6个定位反馈则定位成功，超时后收到定位反馈大于等于4依然能恢复完整对象，反馈小于等于3则失败

version包：GET方法调用，查询所有对象或者指定对象的所有版本





数据层：dataServer包

提供数据的存储功能，处理来自接口服务的请求并在本地磁盘上存取对象

object包：GET等方法，负责对象在本地磁盘上的存取，没有PUT

heartbeat包：发送心跳消息

locate包：接受定位消息，定位对象以及发送反馈消息

temp包：删除objects的PUT方法，新增了temp接口的POST、PATCH、PUT、DELETE四种方法代替。

* post：生成一个随机的uuid，名字和大小并且写入临时文件
* patch：将文件数据写入临时文件并且校验。
* put：转正文件
* delete：删除文件

接口之间通过消息队列通信，原因是消息队列适合群发消息。

每一个数据服务节点持续向apiServer这个exchange（接口服务节点绑定）发送心跳消息，此消息转发给绑定这个exchange的所有消息队列，也就是每一个服务节点都会收到任意数据服务节点的心跳消息。

每一个接口服务需要定位对象保存在哪个数据服务节点，因此创建dataServer这个exchange，所有的数据服务节点绑定该exchange，并且接收来自接口的定位消息，拥有该对象的数据服务节点使用消息单发通知接口服务节点。



> 封装消息队列包amqp，得到自己的消息队列。
>
> rabbitmq.RabbitMQ结构体
>
> Bind方法：将自己的消息队列与一个exchange绑定，所有发往exchange的消息都可以在自己的消息队列中被接收到。
>
> Send方法：往某个消息队列发送消息。
>
> Publish方法：往某个exchange发送消息
>
> Consume方法：生成一个接收消息的 go channel
>
> Close方法：关闭消息队列





### 对象存储——元数据

元数据服务ElasticSearch，分布式数据库，足够方便，同样使用REST接口

元数据metadata索引使用的映射，定义数据库表的结构，为name，version，size和hash

### 去重

去重，消除重复数据多余副本的数据压缩技术

基于对象的全局唯一标识符，通过对该对象的散列值进行单例检查来实现。

必须进行数据校验，验证客户端提供的散列值和我们自己根据对象数据计算出来的散列值是否一致。有了数据校验才可以确保数据服务中保存的对象数据和散列值一致，然后对后续上传的对象根据散列值进行去重。



### 数据冗余和即时修复

数据在传输过程中的丢失通常是由于网络不稳定导致的，对数据进行校验可以有效检测出数据传输过程中发生的数据丢失，服务端可以拒收有损的数据，客户端重新上传

存储过程中可能发生存储硬件损坏、服务器维护、数据降解等情况，因此要依靠数据冗余

额外数据纠正错误，这里使用额外空间少一些的RS纠删码，接口服务会将客户端PUT上来的数据流切成4+2的分片，然后向6个数据服务节点上传临时对象，同时计算对象散列值，如果散列值一致，6个临时对象会被转成正式的分片对象。

RS可以配置数据片和校验片的数量，校验片越多，修复余地越大。

数据的修复不能只依靠即时修复技术来进行，有些对象可能因为长期没有发生GET导致始终得不到修复，最终由于损坏的数据片过多而无法修复，所以还需要后台修复工具，持续检查对象存储系统上的所有对象并进行修复。



### 断点续传功能

网络连接的不稳定，导致在上传或者下载一个大对象时可能因为网络断开导致上传下载失败。

断点下载只需要设置一个位置即可，但是断点上传更为复杂。



断点服务需要一开始就要客户端和接口服务做好约定，使用特定的接口进行上传。



### 数据压缩

分片临时对象压缩后再写入转正后的文件。



### 数据维护

#### 版本留存

保留用户更关注的版本的情况下清理一些不必要的版本。

这里只保留最后5个版本。

#### 数据定期检查和修复



garbage目录下的文件需要定期检查，超过一定时间后彻底删除，删除前要确定元数据服务中不存在相关散列值。





客户端

由于去重导致的小文件性能问题，有效的解决方式是在客户端优化，将多个小文件尽量打包成一个大对象上传而不是分别上传

客户端每次用PUT方法访问token之前都要先用HEAD方法获取当前已经上传了多少数据。断点上传比较复杂，HTTP服务的特点，需要使用新的对象POST接口创建一个token，并通过接口服务的temp接口访问token上传数据，客户端需要根据上传对象的大小自行选择上传的方式，对于小对象，客户端可以使用之前dePUTy方法上传，对于大对象，客户端需要选择POST方法并自行分块上传。



数据压缩最适合放在客户端，高性能客户端可以将大量小对象打包成大对象提高存储和传输的效率，也可以在客户机本地进行数据压缩，进一步节省网络带宽和存储功能。

